on: [push, pull_request]

name: Continuous integration

jobs:
    tests:
        name: Tests
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - rust: stable
                    - rust: nightly
                    - rust: 1.48.0
        steps:
            - name: Checkout Crate
              uses: actions/checkout@v2
            - name: Checkout Toolchain
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: ${{ matrix.rust }}
                  override: true
            - run: cargo update --package backtrace --precise 0.3.50
            - run: cargo update --package async-trait --precise 0.1.53
            - run: cargo update --package serde --precise 1.0.152
            - name: Running test script
              run: ./contrib/test.sh

    integrations-tests:
        name: Integration Tests
        runs-on: ubuntu-latest
        strategy:
            matrix:
                rust: [stable]
                bitcoinversion:
                    [
                        "0.18.0",
                        "0.18.1",
                        "0.19.0.1",
                        "0.19.1",
                        "0.20.0",
                        "0.20.1",
                        "0.21.0",
                    ]
        steps:
            - name: Checkout Crate
              uses: actions/checkout@v2
            - name: Checkout Toolchain
              uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: ${{ matrix.rust }}
                  override: true
            - name: Running test script
              env:
                  BITCOINVERSION: ${{ matrix.bitcoinversion }}
              run: ./contrib/test.sh
